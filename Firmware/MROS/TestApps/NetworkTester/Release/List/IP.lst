##############################################################################
#                                                                            #
# IAR Atmel AVR C/EC++ Compiler V2.28A/WIN, Evaluation Version04/Dec/2007  19:35:46 #
# Copyright 1996-2002 IAR Systems. All rights reserved.                      #
#                                                                            #
#    Source file  =  f:\Projects\[Drivers]\C\MROS\Network\IP.c               #
#    Command line =  --cpu=m32 -ms -o f:\Projects\[Drivers]\C\MROS\TestApps\ #
#                    NetworkTester\Release\Obj\ -I "C:\Program Files\IAR     #
#                    Systems\Ew23 Evaluation version\avr\SRC\CLIB\INC\" -I   #
#                    f:\Projects\[Drivers]\C\MROS\TestApps\NetworkTester\    #
#                    -I f:\Projects\[Drivers]\C\MROS\ -I                     #
#                    f:\Projects\[Drivers]\C\MROS\Network\ -lC               #
#                    f:\Projects\[Drivers]\C\MROS\TestApps\NetworkTester\Rel #
#                    ease\List\ -e --initializers_in_flash -s9 --debug       #
#                    -DENABLE_BIT_DEFINITIONS f:\Projects\[Drivers]\C\MROS\N #
#                    etwork\IP.c                                             #
#    List file    =  f:\Projects\[Drivers]\C\MROS\TestApps\NetworkTester\Rel #
#                    ease\List\IP.lst                                        #
#    Object file  =  f:\Projects\[Drivers]\C\MROS\TestApps\NetworkTester\Rel #
#                    ease\Obj\IP.r90                                         #
#                                                                            #
#                                                                            #
##############################################################################

      1          #include "Network.h"
      2          
      3          
      4          // The local IP

   \                                 In segment NEAR_Z, align 1, keep-with-next
   \   00000000                              REQUIRE `?<Segment init: NEAR_Z>`
      5          unsigned long ip;
   \   unsigned long __near ip;
   \                     ip:
   \   00000000                              DS 4
      6          
      7          
      8          /*
      9          	Sends an IP datagram to the specified destination.
     10          */

   \                                 In segment CODE, align 2, keep-with-next
     11          void IP_Send(unsigned long destination, unsigned char protocol, unsigned char *buffer, unsigned short packetLength)
     12          {
   \   __nearfunc void IP_Send(unsigned long, unsigned char, unsigned char *, unsigned short);
   \                     IP_Send:
   \   00000000   92BA                       ST      -Y,R11
   \   00000002   92AA                       ST      -Y,R10
   \   00000004   929A                       ST      -Y,R9
   \   00000006   928A                       ST      -Y,R8
   \   00000008   926A                       ST      -Y,R6
   \   0000000A   925A                       ST      -Y,R5
   \   0000000C   924A                       ST      -Y,R4
   \   0000000E   93BA                       ST      -Y,R27
   \   00000010   93AA                       ST      -Y,R26
   \   00000012   939A                       ST      -Y,R25
   \   00000014   938A                       ST      -Y,R24
   \   00000016                              REQUIRE ?Register_R4_is_cg_reg
   \   00000016                              REQUIRE ?Register_R5_is_cg_reg
   \   00000016                              REQUIRE ?Register_R6_is_cg_reg
   \   00000016                              REQUIRE ?Register_R8_is_cg_reg
   \   00000016                              REQUIRE ?Register_R9_is_cg_reg
   \   00000016                              REQUIRE ?Register_R10_is_cg_reg
   \   00000016                              REQUIRE ?Register_R11_is_cg_reg
   \   00000016   9726                       SBIW    R29 : R28,6
   \   00000018   0148                       MOVW    R9 : R8,R17 : R16
   \   0000001A   0159                       MOVW    R11 : R10,R19 : R18
   \   0000001C   2E64                       MOV     R6,R20
   \   0000001E   01CB                       MOVW    R25 : R24,R23 : R22
   \   00000020   89A9                       LDD     R26,Y+17
   \   00000022   89BA                       LDD     R27,Y+18
     13          //const unsigned char *TargetMAC=ARP_LookUp(Destination);
     14          //unsigned char BroadcastMAC[6]={0xff,0xff,0xff,0xff,0xff,0xff};
     15          unsigned char pcMac[6]={0x00,0x1a,0x92,0x9d,0x42,0x64};
   \   00000024   018E                       MOVW    R17 : R16,R29 : R28
   \   00000026   ....                       LDI     R30,LOW(`?<Constant {(unsigned char)'\\000', (unsigned c`)
   \   00000028   ....                       LDI     R31,(`?<Constant {(unsigned char)'\\000', (unsigned c`) >> 8
   \   0000002A   E046                       LDI     R20,6
   \   0000002C   E050                       LDI     R21,0
   \   0000002E   ........                   CALL    ?ML_FLASH_SRAM_16_16_L07
     16          
     17          /*
     18          	if(TargetMAC==NULL)
     19          	{
     20          		// Perform ARP request on 'destination'
     21          	}
     22          */
     23          
     24          	buffer[IP_VERSION] = 0x40 | 5;
   \   00000032   012B                       MOVW    R5 : R4,R23 : R22
   \   00000034   E00E                       LDI     R16,14
   \   00000036   0E40                       ADD     R4,R16
   \   00000038   E000                       LDI     R16,0
   \   0000003A   1E50                       ADC     R5,R16
   \   0000003C   E405                       LDI     R16,69
   \   0000003E   01F2                       MOVW    R31 : R30,R5 : R4
   \   00000040   8300                       ST      Z,R16
     25          	buffer[IP_TYPE] = 0;
   \   00000042   E000                       LDI     R16,0
   \   00000044   8301                       STD     Z+1,R16
     26          	PutShort(buffer + IP_LENGTH, packetLength + IP_HEADER_SIZE);
   \   00000046   9654                       ADIW    R27 : R26,20
   \   00000048   019D                       MOVW    R19 : R18,R27 : R26
   \   0000004A   018B                       MOVW    R17 : R16,R23 : R22
   \   0000004C   5F00                       SUBI    R16,240
   \   0000004E   4F1F                       SBCI    R17,255
   \   00000050   ........                   CALL    PutShort
     27          	PutShort(buffer + IP_ID, 1);
   \   00000054   E021                       LDI     R18,1
   \   00000056   E030                       LDI     R19,0
   \   00000058   018C                       MOVW    R17 : R16,R25 : R24
   \   0000005A   5E0E                       SUBI    R16,238
   \   0000005C   4F1F                       SBCI    R17,255
   \   0000005E   ........                   CALL    PutShort
     28          	PutShort(buffer + IP_FRAGMENT, 0);
   \   00000062   E020                       LDI     R18,0
   \   00000064   E030                       LDI     R19,0
   \   00000066   018C                       MOVW    R17 : R16,R25 : R24
   \   00000068   5E0C                       SUBI    R16,236
   \   0000006A   4F1F                       SBCI    R17,255
   \   0000006C   ........                   CALL    PutShort
     29          	buffer[IP_TTL] = 128;
   \   00000070   E800                       LDI     R16,128
   \   00000072   01F2                       MOVW    R31 : R30,R5 : R4
   \   00000074   8700                       STD     Z+8,R16
     30          	buffer[IP_PROTOCOL] = protocol;
   \   00000076   8661                       STD     Z+9,R6
     31          	PutShort(buffer + IP_CHECKSUM, 0);
   \   00000078   E020                       LDI     R18,0
   \   0000007A   E030                       LDI     R19,0
   \   0000007C   018C                       MOVW    R17 : R16,R25 : R24
   \   0000007E   5E08                       SUBI    R16,232
   \   00000080   4F1F                       SBCI    R17,255
   \   00000082   ........                   CALL    PutShort
     32          	PutLong(buffer + IP_SOURCE, ip);
   \   00000086   ....                       LDI     R30,LOW(ip)
   \   00000088   ....                       LDI     R31,(ip) >> 8
   \   0000008A   8140                       LD      R20,Z
   \   0000008C   8151                       LDD     R21,Z+1
   \   0000008E   8162                       LDD     R22,Z+2
   \   00000090   8173                       LDD     R23,Z+3
   \   00000092   018C                       MOVW    R17 : R16,R25 : R24
   \   00000094   5E06                       SUBI    R16,230
   \   00000096   4F1F                       SBCI    R17,255
   \   00000098   ........                   CALL    PutLong
     33          	PutLong(buffer + IP_DESTINATION, destination);
   \   0000009C   01A4                       MOVW    R21 : R20,R9 : R8
   \   0000009E   01B5                       MOVW    R23 : R22,R11 : R10
   \   000000A0   018C                       MOVW    R17 : R16,R25 : R24
   \   000000A2   5E02                       SUBI    R16,226
   \   000000A4   4F1F                       SBCI    R17,255
   \   000000A6   ........                   CALL    PutLong
     34          	PutShort(buffer + IP_CHECKSUM, OnesComplementChecksum(buffer + IP_HEADER, IP_HEADER_SIZE));
   \   000000AA   E124                       LDI     R18,20
   \   000000AC   E030                       LDI     R19,0
   \   000000AE   0182                       MOVW    R17 : R16,R5 : R4
   \   000000B0   ........                   CALL    OnesComplementChecksum
   \   000000B4   0198                       MOVW    R19 : R18,R17 : R16
   \   000000B6   018C                       MOVW    R17 : R16,R25 : R24
   \   000000B8   5E08                       SUBI    R16,232
   \   000000BA   4F1F                       SBCI    R17,255
   \   000000BC   ........                   CALL    PutShort
     35          	ETHERNET_Send(pcMac, ETHERNET_TYPE_IP, buffer, packetLength + IP_HEADER_SIZE);
   \   000000C0   01BD                       MOVW    R23 : R22,R27 : R26
   \   000000C2   01AC                       MOVW    R21 : R20,R25 : R24
   \   000000C4   E020                       LDI     R18,0
   \   000000C6   E038                       LDI     R19,8
   \   000000C8   018E                       MOVW    R17 : R16,R29 : R28
   \   000000CA   ........                   CALL    ETHERNET_Send
     36          
     37          	return;
   \   000000CE   9626                       ADIW    R29 : R28,6
   \   000000D0   9189                       LD      R24,Y+
   \   000000D2   9199                       LD      R25,Y+
   \   000000D4   91A9                       LD      R26,Y+
   \   000000D6   91B9                       LD      R27,Y+
   \   000000D8   9049                       LD      R4,Y+
   \   000000DA   9059                       LD      R5,Y+
   \   000000DC   9069                       LD      R6,Y+
   \   000000DE   9089                       LD      R8,Y+
   \   000000E0   9099                       LD      R9,Y+
   \   000000E2   90A9                       LD      R10,Y+
   \   000000E4   90B9                       LD      R11,Y+
   \   000000E6   9622                       ADIW    R29 : R28,2
   \   000000E8   9508                       RET
     38          
     39          /*	if(TargetMAC)
     40          		ETHERNET_Send(TargetMAC,ETHERNET_TYPE_IP,Buffer,PacketLength+IP_HEADER_SIZE);
     41          	else
     42          		ETHERNET_Send(BroadcastMAC,ETHERNET_TYPE_IP,Buffer,PacketLength+IP_HEADER_SIZE);
     43          */
     44          }
     45          
     46          

   \                                 In segment CODE, align 2, keep-with-next
     47          void IP_Receive(unsigned char *buffer)
     48          {
   \   __nearfunc void IP_Receive(unsigned char *);
   \                     IP_Receive:
   \   00000000   93BA                       ST      -Y,R27
   \   00000002   93AA                       ST      -Y,R26
   \   00000004   939A                       ST      -Y,R25
   \   00000006   938A                       ST      -Y,R24
   \   00000008   01C8                       MOVW    R25 : R24,R17 : R16
     49          	if(	(buffer[IP_VERSION] == 0x40 | 5) &&																									// IP version 4 and header length = 5 * 4 bytes
     50          			(GetLong(buffer + IP_DESTINATION) == ip)																					// Destination is me
     51          		)
   \   0000000A   01D8                       MOVW    R27 : R26,R17 : R16
   \   0000000C   961E                       ADIW    R27 : R26,14
   \   0000000E   910C                       LD      R16,X
   \   00000010   3400                       CPI     R16,64
   \   00000012   F411                       BRNE    ??IP_Receive_0
   \   00000014   E001                       LDI     R16,1
   \   00000016   C001                       RJMP    ??IP_Receive_1
   \                     ??IP_Receive_0:
   \   00000018   E000                       LDI     R16,0
   \                     ??IP_Receive_1:
   \   0000001A   E025                       LDI     R18,5
   \   0000001C   2B20                       OR      R18,R16
   \   0000001E   F131                       BREQ    ??IP_Receive_2
   \   00000020   018C                       MOVW    R17 : R16,R25 : R24
   \   00000022   5E02                       SUBI    R16,226
   \   00000024   4F1F                       SBCI    R17,255
   \   00000026   ........                   CALL    GetLong
   \   0000002A   ....                       LDI     R30,LOW(ip)
   \   0000002C   ....                       LDI     R31,(ip) >> 8
   \   0000002E   8140                       LD      R20,Z
   \   00000030   8151                       LDD     R21,Z+1
   \   00000032   8162                       LDD     R22,Z+2
   \   00000034   8173                       LDD     R23,Z+3
   \   00000036   1704                       CP      R16,R20
   \   00000038   0715                       CPC     R17,R21
   \   0000003A   0726                       CPC     R18,R22
   \   0000003C   0737                       CPC     R19,R23
   \   0000003E   F4B1                       BRNE    ??IP_Receive_2
     52          	{
     53          		switch(buffer[IP_PROTOCOL])																													// Demultiplex packet
   \   00000040   01FD                       MOVW    R31 : R30,R27 : R26
   \   00000042   8501                       LDD     R16,Z+9
   \   00000044   950A                       DEC     R16
   \   00000046   F019                       BREQ    ??IP_Receive_3
   \   00000048   5100                       SUBI    R16,16
   \   0000004A   F069                       BREQ    ??IP_Receive_4
   \   0000004C   C00F                       RJMP    ??IP_Receive_2
     54          		{
     55          			case IP_PROTOCOL_ICMP:	ICMP_Receive(buffer, GetShort(buffer + IP_LENGTH) - IP_HEADER_SIZE);	// Pass packet to ICMP. The length is the length of the ICMP packet (ie not including the IP header)
   \                     ??IP_Receive_3:
   \   0000004E   018C                       MOVW    R17 : R16,R25 : R24
   \   00000050   5F00                       SUBI    R16,240
   \   00000052   4F1F                       SBCI    R17,255
   \   00000054   ........                   CALL    GetShort
   \   00000058   5104                       SUBI    R16,20
   \   0000005A   4010                       SBCI    R17,0
   \   0000005C   0198                       MOVW    R19 : R18,R17 : R16
   \   0000005E   018C                       MOVW    R17 : R16,R25 : R24
   \   00000060   ........                   CALL    ICMP_Receive
   \   00000064   C003                       RJMP    ??IP_Receive_2
     56          															break;
     57          			case IP_PROTOCOL_TCP:		
     58          															break;
     59          			case IP_PROTOCOL_UDP:		UDP_Receive(buffer);																			// Pass packet to UDP.
   \                     ??IP_Receive_4:
   \   00000066   018C                       MOVW    R17 : R16,R25 : R24
   \   00000068   ........                   CALL    UDP_Receive
     60          															break;
     61          		}
     62          	}
     63          }
   \                     ??IP_Receive_2:
   \   0000006C   9189                       LD      R24,Y+
   \   0000006E   9199                       LD      R25,Y+
   \   00000070   91A9                       LD      R26,Y+
   \   00000072   91B9                       LD      R27,Y+
   \   00000074   9508                       RET

   \                                 In segment NEAR_F, align 1, keep-with-next
   \   unsigned char __flash <Constant {(unsigned char)'\000', (unsigned char)'\032', (unsigned char)'’', (unsigned char)'\235', (unsigned char)'B', (unsigned char)'d'}>[6];
   \                     `?<Constant {(unsigned char)'\\000', (unsigned c`:
   \   00000000   00                         DB 0
   \   00000001   1A                         DB 26
   \   00000002   92                         DB 146
   \   00000003   9D                         DB 157
   \   00000004   42                         DB 66
   \   00000005   64                         DB 100

   Maximum stack usage in bytes:

     Function                     CSTACK  RSTACK
     --------                     ------  ------
     IP_Receive                       4       2 
       -> GetLong                     4       2 
       -> GetShort                    4       2 
       -> ICMP_Receive                4       2 
       -> UDP_Receive                 4       2 
     IP_Send                         19       2 
       -> PutShort                   19       2 
       -> PutShort                   19       2 
       -> PutShort                   19       2 
       -> PutShort                   19       2 
       -> PutLong                    19       2 
       -> PutLong                    19       2 
       -> OnesComplementChecksum     19       2 
       -> PutShort                   19       2 
       -> ETHERNET_Send              19       2 

 
    352 bytes in segment CODE
      6 bytes in segment INITTAB
      6 bytes in segment NEAR_F
      4 bytes in segment NEAR_Z
 
    358 bytes of CODE memory (+ 6 bytes shared)
      4 bytes of DATA memory

Errors: none
Warnings: none
