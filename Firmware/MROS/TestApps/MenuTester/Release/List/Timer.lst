##############################################################################
#                                                                            #
# IAR Atmel AVR C/EC++ Compiler V2.28A/WIN, Evaluation Version30/Nov/2007  23:47:26 #
# Copyright 1996-2002 IAR Systems. All rights reserved.                      #
#                                                                            #
#    Source file  =  f:\Projects\[Drivers]\C\MROS\Kernel\Timer.c             #
#    Command line =  --cpu=m32 -ms -o f:\Projects\[Drivers]\C\MROS\TestApps\ #
#                    MenuTester\Release\Obj\ -I                              #
#                    C:\PROGRA~1\IARSYS~1\EW23EV~1\avr\SRC\CLIB\INC\ -I      #
#                    f:\Projects\[Drivers]\C\MROS\ -I                        #
#                    f:\Projects\[Drivers]\C\MROS\TestApps\MenuTester\       #
#                    --string_literals_in_flash -lC                          #
#                    f:\Projects\[Drivers]\C\MROS\TestApps\MenuTester\Releas #
#                    e\List\ -e --initializers_in_flash -s9                  #
#                    -DENABLE_BIT_DEFINITIONS f:\Projects\[Drivers]\C\MROS\K #
#                    ernel\Timer.c                                           #
#    List file    =  f:\Projects\[Drivers]\C\MROS\TestApps\MenuTester\Releas #
#                    e\List\Timer.lst                                        #
#    Object file  =  f:\Projects\[Drivers]\C\MROS\TestApps\MenuTester\Releas #
#                    e\Obj\Timer.r90                                         #
#                                                                            #
#                                                                            #
##############################################################################

      1          #include <globals.h>

   \                                 In segment ABSOLUTE, at 0x53
   \   union <unnamed> volatile __io _A_TCCR0;
   \                     _A_TCCR0:
   \   00000000                              DS 1

   \                                 In segment ABSOLUTE, at 0x59
   \   union <unnamed> volatile __io _A_TIMSK;
   \                     _A_TIMSK:
   \   00000000                              DS 1

   \                                 In segment ABSOLUTE, at 0x5c
   \   union <unnamed> volatile __io _A_OCR0;
   \                     _A_OCR0:
   \   00000000                              DS 1
      2          #include <Kernel/Timer.h>
      3          #include <Kernel/KernelInternals.h>
      4          
      5          

   \                                 In segment NEAR_Z, align 1, keep-with-next
   \   00000000                              REQUIRE `?<Segment init: NEAR_Z>`
      6          volatile static unsigned short timerTicks = 0;
   \   static unsigned short volatile __near timerTicks;
   \                     timerTicks:
   \   00000000                              DS 2
      7          
      8          static void (*timerEventHandler)(void) = null;
   \   static void (*__near timerEventHandler)();
   \                     timerEventHandler:
   \   00000002                              DS 2
      9          
     10          

   \                                 In segment CODE, align 2, keep-with-next
     11          void Kernel_InitTimer(void (*handler)(void))
     12          {
     13          #if defined(__IOM8_H)
     14          	TCCR0 = TIMER_PRESCALER;
     15          	TCNT0 = (unsigned char)(0-TIMER_RELOAD);
     16          	TIMSK |= (1<<TOIE0);
     17          #elif defined(__IOM32_H)
     18          	TCCR0 = (1<<WGM01)|TIMER_PRESCALER;
   \   __nearfunc void Kernel_InitTimer(void (*)());
   \                     Kernel_InitTimer:
   \   00000000   E02B                       LDI     R18,11
   \   00000002   BF23                       OUT     0x33,R18
     19          	OCR0 = TIMER_RELOAD;
   \   00000004   EA2C                       LDI     R18,172
   \   00000006   BF2C                       OUT     0x3C,R18
     20          	TIMSK |= (1<<OCIE0);
   \   00000008   B729                       IN      R18,0x39
   \   0000000A   6022                       ORI     R18,0x02
   \   0000000C   BF29                       OUT     0x39,R18
     21          #elif defined(__IOM128_H) || defined(__IOM64_H)
     22          	TCCR0 = (1<<WGM01)|TIMER_PRESCALER;
     23          	OCR0 = TIMER_RELOAD;
     24          	TIMSK |= (1<<OCIE0);
     25          #else
     26          #error MROS_Kernel_Timer does not support the selected processor!
     27          #endif
     28          	timerEventHandler = handler;
   \   0000000E   ....                       LDI     R30,LOW(timerEventHandler)
   \   00000010   ....                       LDI     R31,(timerEventHandler) >> 8
   \   00000012   8300                       ST      Z,R16
   \   00000014   8311                       STD     Z+1,R17
     29          }
   \   00000016   9508                       RET
     30          
     31          

   \                                 In segment CODE, align 2, keep-with-next
     32          void Kernel_Delay(unsigned short time)
     33          {
     34          #if TASKER_DEBUG_LEVEL > 0
     35          	Kernel_DebuggerEvent(DEBUG_EVENT_DELAY, null, DEBUG_STATUS_OK, time);
     36          #endif
     37          
     38          	Critical();
   \   __nearfunc void Kernel_Delay(unsigned short);
   \                     Kernel_Delay:
   \   00000000   94F8                       CLI
     39          	
     40          	timerTicks = time;
   \   00000002   ....                       LDI     R30,LOW(timerTicks)
   \   00000004   ....                       LDI     R31,(timerTicks) >> 8
   \   00000006   8300                       ST      Z,R16
   \   00000008   8311                       STD     Z+1,R17
   \   0000000A   C002                       RJMP    ??Kernel_Delay_0
     41          	while(timerTicks > 0)
     42          	{
     43          		NonCritical();
     44          		__no_operation();
   \                     ??Kernel_Delay_1:
   \   0000000C   0000                       NOP
     45          		Critical();
   \   0000000E   94F8                       CLI
   \                     ??Kernel_Delay_0:
   \   00000010   8100                       LD      R16,Z
   \   00000012   8111                       LDD     R17,Z+1
   \   00000014   2B01                       OR      R16,R17
   \   00000016   9478                       SEI
   \   00000018   F7C9                       BRNE    ??Kernel_Delay_1
     46          	}
     47          	NonCritical();
     48          }
   \   0000001A   9508                       RET
     49          
     50          
     51          #if defined(__IOM8_H)
     52          #pragma vector=TIMER0_OVF_vect
     53          #elif defined(__IOM32_H) || defined(__IOM128_H) || defined(__IOM64_H)
     54          #pragma vector=TIMER0_COMP_vect
     55          #else
     56          #error MROS_Kernel_Timer does not support the selected processor!
     57          #endif

   \                                 In segment CODE, align 2, keep-with-next
     58          __interrupt void Kernel_TimerInterruptHandler(void)
     59          {
   \   __nearfunc __interrupt void Kernel_TimerInterruptHandler();
   \                     Kernel_TimerInterruptHandler:
   \   00000000   938A                       ST      -Y,R24
   \   00000002   93FA                       ST      -Y,R31
   \   00000004   93EA                       ST      -Y,R30
   \   00000006   923A                       ST      -Y,R3
   \   00000008   922A                       ST      -Y,R2
   \   0000000A   921A                       ST      -Y,R1
   \   0000000C   920A                       ST      -Y,R0
   \   0000000E   937A                       ST      -Y,R23
   \   00000010   936A                       ST      -Y,R22
   \   00000012   935A                       ST      -Y,R21
   \   00000014   934A                       ST      -Y,R20
   \   00000016   933A                       ST      -Y,R19
   \   00000018   932A                       ST      -Y,R18
   \   0000001A   931A                       ST      -Y,R17
   \   0000001C   930A                       ST      -Y,R16
   \   0000001E   B78F                       IN      R24,0x3F
     60          #if defined(__IOM8_H)
     61          	TCNT0 = (unsigned char)(0-TIMER_RELOAD);
     62          #endif
     63          
     64          	if(timerTicks > 0)
   \   00000020   ....                       LDI     R30,LOW(timerTicks)
   \   00000022   ....                       LDI     R31,(timerTicks) >> 8
   \   00000024   8100                       LD      R16,Z
   \   00000026   8111                       LDD     R17,Z+1
   \   00000028   2B01                       OR      R16,R17
   \   0000002A   F031                       BREQ    ??Kernel_TimerInterruptHandler_0
     65          	{
     66          		timerTicks--;
   \   0000002C   8100                       LD      R16,Z
   \   0000002E   8111                       LDD     R17,Z+1
   \   00000030   5001                       SUBI    R16,1
   \   00000032   4010                       SBCI    R17,0
   \   00000034   8300                       ST      Z,R16
   \   00000036   8311                       STD     Z+1,R17
     67          	}
     68          
     69          	if(timerEventHandler != null)
   \                     ??Kernel_TimerInterruptHandler_0:
   \   00000038   8122                       LDD     R18,Z+2
   \   0000003A   8133                       LDD     R19,Z+3
   \   0000003C   E000                       LDI     R16,0
   \   0000003E   3020                       CPI     R18,0
   \   00000040   0730                       CPC     R19,R16
   \   00000042   F011                       BREQ    ??Kernel_TimerInterruptHandler_1
     70          	{
     71          		timerEventHandler();
   \   00000044   01F9                       MOVW    R31 : R30,R19 : R18
   \   00000046   9509                       ICALL
     72          	}
     73          }
   \                     ??Kernel_TimerInterruptHandler_1:
   \   00000048   BF8F                       OUT     0x3F,R24
   \   0000004A   9109                       LD      R16,Y+
   \   0000004C   9119                       LD      R17,Y+
   \   0000004E   9129                       LD      R18,Y+
   \   00000050   9139                       LD      R19,Y+
   \   00000052   9149                       LD      R20,Y+
   \   00000054   9159                       LD      R21,Y+
   \   00000056   9169                       LD      R22,Y+
   \   00000058   9179                       LD      R23,Y+
   \   0000005A   9009                       LD      R0,Y+
   \   0000005C   9019                       LD      R1,Y+
   \   0000005E   9029                       LD      R2,Y+
   \   00000060   9039                       LD      R3,Y+
   \   00000062   91E9                       LD      R30,Y+
   \   00000064   91F9                       LD      R31,Y+
   \   00000066   9189                       LD      R24,Y+
   \   00000068   9518                       RETI

   \                                 In segment INTVEC, offset 0x28, root
   \   00000000   ........                   JMP     Kernel_TimerInterruptHandler

   Maximum stack usage in bytes:

     Function                      CSTACK  RSTACK
     --------                      ------  ------
     Kernel_Delay                      0       0 
     Kernel_InitTimer                  0       0 
     Kernel_TimerInterruptHandler     15       2 
       ->   Indirect call             15       2 

 
      3 bytes in segment ABSOLUTE
    158 bytes in segment CODE
      6 bytes in segment INITTAB
      4 bytes in segment INTVEC
      4 bytes in segment NEAR_Z
 
    162 bytes of CODE memory (+ 6 bytes shared)
      4 bytes of DATA memory (+ 3 bytes shared)

Errors: none
Warnings: none
